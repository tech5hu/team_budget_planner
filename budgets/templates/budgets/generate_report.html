{% extends 'budgets/index.html' %}

{% block content %}
  <h1>Generate Report</h1>

  <form method="post" action="{% url 'budgets:generate_report' %}">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Generate Report</button>
  </form>

  {% if transactions %}
    <h2>Report Summary</h2>

    <!-- Bar Chart for Total Spending by Category -->
    <canvas id="categorySpendingChart" width="400" height="200"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const ctx = document.getElementById('categorySpendingChart').getContext('2d');
      const categories = [];
      const amounts = [];
      
      {% for transaction in transactions %}
        categories.push('{{ transaction.expense_category.name }}');
        amounts.push({{ transaction.amount }});
      {% endfor %}

      const uniqueCategories = [...new Set(categories)];
      const categoryTotals = uniqueCategories.map(category => {
        return categories.reduce((total, currentCategory, index) => {
          return currentCategory === category ? total + amounts[index] : total;
        }, 0);
      });

      const categorySpendingChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: uniqueCategories,
          datasets: [{
            label: 'Spending by Category (£)',
            data: categoryTotals,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    </script>

    <p>Total Amount: £{{ total_amount|floatformat:2 }}</p> <!-- Format total amount -->

    <!-- Enhanced Table for Transactions -->
    <div class="report-container">
      <table class="report-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Amount (£)</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in transactions %}
            <tr>
              <td>{{ transaction.transaction_date }}</td>
              <td>{{ transaction.expense_category.name }}</td>
              <td>£{{ transaction.amount|floatformat:2 }}</td>
              <td>{{ transaction.description }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4">No transactions found</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
{% endblock %}
